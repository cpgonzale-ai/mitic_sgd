/**
 * DIGITALIA - SISTEMA INTEGRADO DE GESTIÓN DE GOBIERNO
 * ------------------------------------------------------------------
 * Autor: Equipo de Desarrollo Digitalia
 * Versión: 3.0.1
 * Descripción: 
 * Este archivo contiene la lógica completa del frontend para el prototipo
 * de Digitalia. Incluye tres módulos principales:
 * 1. Dashboard Principal (Home)
 * 2. Módulo de Expedientes Electrónicos (Simulación de bandejas y flujo)
 * 3. Módulo de Gestión Documental (GDL) (Repositorio, validación y sellado)
 * * Nota para desarrolladores:
 * En un entorno de producción, estos módulos deben separarse en carpetas
 * independientes (/components, /pages, /context).
 */

import React, { useState, useEffect } from 'react';
import { 
  Menu, Search, Bell, Mail, HelpCircle, Settings, ChevronLeft, 
  User, Plus, Filter, X, FileText, CheckCircle, Link as LinkIcon, 
  Download, Eye, MoreVertical, Clock, ShieldCheck, FolderOpen, 
  LayoutDashboard, FileInput, Files, Users, BarChart, Database, 
  Save, AlertCircle, Sparkles, MessageSquare, Loader2, Upload,
  ArrowLeft, ArrowRight, Home, Building, FileCheck, QrCode,
  File, Edit3, Monitor, Trash2, Shield, CheckSquare, Square,
  LogOut, Grid
} from 'lucide-react';

// ==================================================================================
// CONFIGURACIÓN & MOCK DATA (Simulación de Backend)
// ==================================================================================

// Datos simulados para el módulo de Expedientes
const GDL_SOURCE_DOCUMENTS_EXP = [
  { id: 'DOC-2026-001', title: 'Resolución Ministerial 45/2026', type: 'Resolución', author: 'Rodrigo Antola', date: '02/02/2026', status: 'Firmado', size: '2.4 MB' },
  { id: 'DOC-2026-002', title: 'Informe Técnico Auditoría Interna', type: 'Informe Técnico', author: 'Cynthia Gonzalez', date: '01/02/2026', status: 'Borrador', size: '4.1 MB' },
  { id: 'DOC-2026-003', title: 'Dictamen Financiero Proyecto GDL', type: 'Dictamen', author: 'Fernando Mancia', date: '28/01/2026', status: 'Firmado', size: '1.2 MB' },
  { id: 'DOC-2026-004', title: 'Nota de Remisión Nro 500', type: 'Nota', author: 'Mesa de Entrada', date: '25/01/2026', status: 'Recibido', size: '0.5 MB' }
];

// ==================================================================================
// MÓDULO 1: EXPEDIENTES ELECTRÓNICOS
// ==================================================================================

const ExpedientesModule = ({ onBack }) => {
  const [showGDLModal, setShowGDLModal] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [uploadedFiles, setUploadedFiles] = useState([]);

  // Lógica para vincular documentos desde el repositorio
  const handleLinkDocument = (doc) => {
    if (!uploadedFiles.find(f => f.id === doc.id)) {
      setUploadedFiles([...uploadedFiles, {
        id: doc.id, tipo: doc.type, nombre: doc.title, tamano: doc.size, fecha: doc.date
      }]);
    }
    setShowGDLModal(false);
    setSearchTerm('');
  };

  const removeFile = (id) => {
    setUploadedFiles(uploadedFiles.filter(f => f.id !== id));
  };

  const SidebarItem = ({ icon: Icon, label, active, badge }) => (
    <div className={`flex items-center px-4 py-3 cursor-pointer text-sm transition-colors relative ${active ? 'bg-slate-100 text-slate-700 font-semibold border-l-4 border-[#0056b3]' : 'text-slate-500 hover:bg-slate-50 border-l-4 border-transparent'}`}>
      <Icon size={18} className="mr-3 shrink-0" />
      <span className="truncate">{label}</span>
      {badge && <span className="absolute right-4 bg-[#2e59d9] text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">{badge}</span>}
    </div>
  );

  return (
    <div className="flex h-screen bg-[#f3f4f6] font-sans overflow-hidden animate-in fade-in duration-300">
      {/* Sidebar Lateral */}
      <aside className="w-64 bg-white border-r border-slate-300 flex flex-col shrink-0 hidden md:flex h-full">
        <div className="flex-1 overflow-y-auto custom-scrollbar">
          <div className="py-4">
            <h3 className="px-4 text-xs font-bold text-slate-400 uppercase mb-2">Expedientes</h3>
            <SidebarItem icon={BarChart} label="Tablero Principal" />
            <div className="group"><SidebarItem icon={FileText} label="Bandeja de Expedientes" /></div>
            <SidebarItem icon={Mail} label="Para Conocimiento" badge="6" />
            <SidebarItem icon={Clock} label="Bandeja de Pase a Firma" badge="1" />
            <SidebarItem icon={FolderOpen} label="Bandeja de Expedientes Archivados" />
            <div className="mt-2"><SidebarItem icon={Plus} label="Crear Expediente" active={true} /></div>
            <SidebarItem icon={ArrowRight} label="Liberar Expediente" />
            <SidebarItem icon={CheckCircle} label="Validar Expediente" />
          </div>
          <div className="py-2 border-t border-slate-100">
            <h3 className="px-4 text-xs font-bold text-slate-400 uppercase mb-2">Administracion</h3>
            <SidebarItem icon={User} label="Personas" />
            <SidebarItem icon={Users} label="Usuarios" />
            <SidebarItem icon={LayoutDashboard} label="Páginas" />
            <SidebarItem icon={ShieldCheck} label="Roles" />
          </div>
        </div>
      </aside>

      {/* Contenido Principal */}
      <div className="flex-1 flex flex-col h-full overflow-hidden">
        <header className="bg-[#1565c0] text-white h-14 flex items-center justify-between px-4 shadow-md shrink-0 z-10">
          <div className="flex items-center space-x-4">
            <button onClick={onBack} className="bg-white/10 hover:bg-white/20 p-1.5 rounded-full transition-colors" title="Volver al Menú Principal">
                <Grid size={18} />
            </button>
            <div className="flex flex-col">
              <h1 className="font-bold text-sm leading-tight">Expedientes Electrónicos</h1>
              <span className="text-[10px] opacity-80 italic">[Versión 1.2.0]</span>
            </div>
            <div className="bg-[#8bc34a] rounded-full p-1 cursor-pointer hover:bg-[#7cb342] shadow-sm">
               <ChevronLeft size={20} className="text-white" strokeWidth={3} />
            </div>
          </div>
          
          <div className="flex items-center space-x-6">
            <div className="text-right hidden sm:block leading-tight">
              <p className="text-xs font-bold uppercase">MAGALI AMARILLA</p>
              <p className="text-[10px] font-medium">MITIC</p>
            </div>
            <div className="flex items-center space-x-3">
              <Settings size={20} className="cursor-pointer opacity-90 hover:opacity-100" />
              <Bell size={20} className="cursor-pointer opacity-90 hover:opacity-100" />
              <Mail size={20} className="cursor-pointer opacity-90 hover:opacity-100" />
              <div className="border border-white rounded-full p-0.5">
                 <HelpCircle size={16} className="cursor-pointer opacity-90 hover:opacity-100" />
              </div>
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 relative bg-[#ebedf0]">
          {/* Tarjeta de Formulario Principal */}
          <div className="bg-white rounded shadow border border-slate-200">
            <div className="px-5 py-3 border-b border-slate-100 flex justify-between items-center">
               <h2 className="text-sm font-bold text-slate-700 uppercase">Documentos Adjuntos del Expediente (Opcional)</h2>
               <div className="flex items-center text-xs text-green-600 bg-green-50 px-3 py-1 rounded border border-green-100">
                  <CheckCircle size={14} className="mr-1"/>
                  <span className="font-medium">Operación exitosa</span>
                  <X size={14} className="ml-2 text-slate-400 cursor-pointer"/>
               </div>
            </div>

            <div className="p-6 space-y-6">
               <div className="grid grid-cols-12 gap-4 items-center">
                  <label className="col-span-12 md:col-span-2 text-xs font-bold text-slate-600">Nro. Expediente</label>
                  <div className="col-span-12 md:col-span-6">
                     <input type="text" value="2025-12021001-000288" readOnly className="w-full border border-slate-300 rounded p-2 text-sm bg-white text-slate-600 outline-none"/>
                  </div>
               </div>

               <div className="grid grid-cols-12 gap-4 items-center">
                  <label className="col-span-12 md:col-span-2 text-xs font-bold text-slate-600 flex">Tipo de Documento <span className="text-red-500 ml-1">*</span></label>
                  <div className="col-span-12 md:col-span-6 relative">
                     <select className="w-full border border-slate-300 rounded p-2 text-sm bg-white text-slate-700 outline-none appearance-none">
                        <option>Generico</option>
                     </select>
                     <div className="absolute right-2 top-1/2 -translate-y-1/2 flex space-x-1">
                        <X size={14} className="text-slate-400 cursor-pointer"/>
                        <ChevronLeft size={14} className="-rotate-90 text-slate-400 pointer-events-none"/>
                     </div>
                  </div>
               </div>

               <div className="grid grid-cols-12 gap-4 items-start border-t border-slate-100 pt-6">
                  <label className="col-span-12 md:col-span-2 text-xs font-bold text-slate-600 flex pt-2">Documento Adjunto <span className="text-red-500 ml-1">*</span></label>
                  <div className="col-span-12 md:col-span-10">
                     <div className="flex flex-wrap gap-2 mb-4">
                        <button className="bg-[#3f51b5] hover:bg-[#303f9f] text-white px-4 py-2 rounded shadow-sm text-sm font-medium flex items-center transition-colors">
                           <span className="text-lg mr-2 leading-none font-bold">+</span> Seleccionar Archivos
                        </button>
                        <button disabled className="bg-slate-200 text-slate-400 px-4 py-2 rounded shadow-sm text-sm font-medium flex items-center cursor-not-allowed">
                           <Upload size={16} className="mr-2" /> Subir Archivo
                        </button>
                        {/* Botón de Integración GDL */}
                        <button onClick={() => setShowGDLModal(true)} className="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow-sm text-sm font-medium flex items-center transition-colors border border-teal-700">
                           <FolderOpen size={16} className="mr-2" /> Vincular con Gestion documental
                        </button>
                        <button className="bg-slate-200 hover:bg-slate-300 text-slate-600 px-4 py-2 rounded shadow-sm text-sm font-medium flex items-center transition-colors">
                           <X size={16} className="mr-2" /> Cancelar
                        </button>
                     </div>
                     <div className="border border-slate-200 h-10 w-full rounded bg-white"></div>
                  </div>
               </div>
            </div>
          </div>

          {/* Tabla de Archivos */}
          <div className="bg-white rounded shadow border border-slate-200 min-h-[250px] flex flex-col">
            <div className="px-5 py-4 border-b border-slate-100">
               <h3 className="text-sm font-bold text-slate-700 uppercase">ARCHIVOS CARGADOS</h3>
            </div>
            <div className="overflow-x-auto flex-1">
               <table className="w-full text-left">
                  <thead className="bg-white border-b border-slate-200">
                     <tr>
                        <th className="px-6 py-3 text-xs font-bold text-slate-600 border-r border-slate-100 w-1/5">Tipo Documento</th>
                        <th className="px-6 py-3 text-xs font-bold text-slate-600 border-r border-slate-100 w-2/5">Documento Adjunto</th>
                        <th className="px-6 py-3 text-xs font-bold text-slate-600 border-r border-slate-100 w-1/5">Tamaño</th>
                        <th className="px-6 py-3 text-xs font-bold text-slate-600 border-r border-slate-100 w-1/5">Fecha Documento</th>
                        <th className="px-6 py-3 text-xs font-bold text-slate-600 w-24">Acción</th>
                     </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                     {uploadedFiles.length === 0 ? (
                        <tr><td colSpan="5" className="px-6 py-12 text-slate-500 text-sm italic">No se encuentran archivos cargados.</td></tr>
                     ) : (
                        uploadedFiles.map((file) => (
                           <tr key={file.id} className="hover:bg-slate-50 transition-colors">
                              <td className="px-6 py-3 text-xs text-slate-600 border-r border-slate-100">{file.tipo}</td>
                              <td className="px-6 py-3 text-xs text-blue-600 font-medium underline cursor-pointer border-r border-slate-100">{file.nombre}</td>
                              <td className="px-6 py-3 text-xs text-slate-600 border-r border-slate-100">{file.tamano}</td>
                              <td className="px-6 py-3 text-xs text-slate-600 border-r border-slate-100">{file.fecha}</td>
                              <td className="px-6 py-3 text-center">
                                 <button onClick={() => removeFile(file.id)} className="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50"><X size={16} /></button>
                              </td>
                           </tr>
                        ))
                     )}
                  </tbody>
               </table>
            </div>
            <div className="p-4 border-t border-slate-100 flex justify-center items-center space-x-4 text-slate-400">
               <span className="cursor-pointer hover:text-slate-600">«</span><span className="cursor-pointer hover:text-slate-600">‹</span>
               <span className="cursor-pointer hover:text-slate-600">›</span><span className="cursor-pointer hover:text-slate-600">»</span>
            </div>
          </div>
          <div className="h-12"></div>
        </main>
        
        {/* Footer Actions */}
        <div className="absolute bottom-4 left-4 md:left-72 z-20">
           <button onClick={onBack} className="bg-[#303f9f] text-white px-4 py-1.5 rounded text-sm font-medium flex items-center shadow-lg hover:bg-[#283593]"> Atrás <ArrowLeft size={14} className="ml-2" /></button>
        </div>
        <div className="absolute bottom-4 right-4 z-20">
           <button className="bg-[#303f9f] text-white px-4 py-1.5 rounded text-sm font-medium flex items-center shadow-lg hover:bg-[#283593]"> Siguiente <ArrowRight size={14} className="ml-2" /></button>
        </div>
      </div>

      {/* Modal de Vinculación GDL */}
      {showGDLModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white w-full max-w-2xl rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[85vh]">
            <div className="bg-[#303f9f] text-white px-6 py-4 flex justify-between items-center">
              <h3 className="font-bold text-lg flex items-center"><FolderOpen size={20} className="mr-2 text-teal-300" /> Repositorio GDL</h3>
              <button onClick={() => setShowGDLModal(false)} className="hover:bg-white/20 p-1 rounded transition-colors"><X size={20} /></button>
            </div>
            <div className="p-4 bg-slate-50 border-b border-slate-200">
              <div className="flex gap-2">
                <div className="relative flex-1">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                  <input type="text" placeholder="Buscar documento por título o autor..." className="w-full pl-9 pr-4 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-[#303f9f] outline-none text-sm"
                    value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>
                <button className="bg-white border border-slate-300 px-4 py-2 rounded text-slate-600 hover:bg-slate-50 text-sm font-medium">Filtros</button>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto p-2 bg-slate-100">
              {GDL_SOURCE_DOCUMENTS_EXP.filter(doc => doc.title.toLowerCase().includes(searchTerm.toLowerCase())).map((doc) => {
                  const isAdded = uploadedFiles.find(f => f.id === doc.id);
                  return (
                    <div key={doc.id} onClick={() => !isAdded && handleLinkDocument(doc)} className={`bg-white p-3 rounded mb-2 border shadow-sm flex items-center justify-between cursor-pointer transition-all ${isAdded ? 'opacity-50 cursor-not-allowed border-slate-200' : 'hover:border-blue-400 hover:shadow-md border-slate-200'}`}>
                      <div className="flex items-center gap-3">
                         <div className={`p-2 rounded ${doc.type === 'Resolución' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}`}><FileText size={20} /></div>
                         <div><p className="font-bold text-sm text-slate-700">{doc.title}</p><p className="text-xs text-slate-500">{doc.id} • {doc.author} • {doc.date}</p></div>
                      </div>
                      {isAdded ? <span className="text-xs font-bold text-green-600 flex items-center bg-green-50 px-2 py-1 rounded"><CheckCircle size={12} className="mr-1"/> Agregado</span> : <span className="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded group-hover:bg-blue-100">Seleccionar</span>}
                    </div>
                  );
              })}
              {GDL_SOURCE_DOCUMENTS_EXP.filter(doc => doc.title.toLowerCase().includes(searchTerm.toLowerCase())).length === 0 && (
                 <div className="text-center py-8 text-slate-400 text-sm">No se encontraron documentos</div>
              )}
            </div>
            <div className="px-4 py-3 bg-white border-t border-slate-200 text-xs text-slate-500 flex justify-between">
               <span>Sistema de Gestión Documental v2.4</span><span>{GDL_SOURCE_DOCUMENTS_EXP.length} registros totales</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================================================================================
// MÓDULO 2: GESTIÓN DOCUMENTAL (GDL)
// ==================================================================================

const GDLSidebarItem = ({ id, icon: Icon, label, active, onClick }) => (
  <button onClick={() => onClick(id)} className={`w-full flex items-center space-x-3 px-4 py-3 text-sm font-medium transition-colors ${active ? 'bg-blue-900 text-white border-r-4 border-blue-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
    <Icon size={20} /> <span>{label}</span>
  </button>
);

const Badge = ({ status }) => {
  const styles = { 'Firmado': 'bg-green-100 text-green-800 border-green-200', 'Borrador': 'bg-yellow-100 text-yellow-800 border-yellow-200', 'Validado': 'bg-blue-100 text-blue-800 border-blue-200', 'Guardado': 'bg-blue-50 text-blue-800 border-blue-200', 'Vigente': 'bg-green-100 text-green-800 border-green-200' };
  return <span className={`px-2 py-1 rounded-full text-xs font-semibold border ${styles[status] || 'bg-gray-100'}`}>{status}</span>;
};

// Vista: Repositorio
const RepositoryView = ({ setActiveTab, documents }) => {
  const [searchQuery, setSearchQuery] = useState('');
  return (
    <div className="space-y-6 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div><h2 className="text-2xl font-bold text-slate-800">Repositorio Central</h2><p className="text-slate-500">Gestión de documentos nativos digitales</p></div>
        <button onClick={() => setActiveTab('create')} className="bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition shadow-sm"><Plus size={18} /><span>Nuevo Documento</span></button>
      </div>
      <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-wrap gap-4 items-center">
        <div className="flex-1 relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
          <input type="text" placeholder="Buscar por título, ID o metadatos..." className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
        </div>
        <div className="flex space-x-2">
          <select className="px-4 py-2 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 focus:outline-none"><option>Todos los Tipos</option><option>Resolución</option><option>Informe Técnico</option><option>Dictamen</option></select>
          <button className="p-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50"><Filter size={20} /></button>
        </div>
      </div>
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-slate-50 text-slate-600 text-sm border-b border-slate-200">
            <tr>
              <th className="px-6 py-4 font-semibold">Documento</th><th className="px-6 py-4 font-semibold">Autor</th><th className="px-6 py-4 font-semibold">Fecha</th><th className="px-6 py-4 font-semibold">Integración Digitalia</th><th className="px-6 py-4 font-semibold">Estado</th><th className="px-6 py-4 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {documents.filter(d => d.title.toLowerCase().includes(searchQuery.toLowerCase())).map((doc) => (
              <tr key={doc.id} className="hover:bg-slate-50 transition-colors group">
                <td className="px-6 py-4"><div className="flex items-start space-x-3"><div className="p-2 bg-blue-50 text-blue-700 rounded-lg"><FileText size={20} /></div><div><p className="font-medium text-slate-900">{doc.title}</p><p className="text-xs text-slate-500 font-mono">{doc.id} • {doc.type}</p></div></div></td>
                <td className="px-6 py-4 text-sm text-slate-600"><div className="flex items-center space-x-2"><User size={14} /><span>{doc.author}</span></div></td>
                <td className="px-6 py-4 text-sm text-slate-600"><div className="flex items-center space-x-2"><Clock size={14} /><span>{doc.date}</span></div></td>
                <td className="px-6 py-4">{doc.digitaliaId ? <span className="flex items-center space-x-1 text-xs font-medium text-indigo-700 bg-indigo-50 px-2 py-1 rounded border border-indigo-100 w-fit"><LinkIcon size={12} /><span>Vinculado: {doc.digitaliaId}</span></span> : <span className="text-xs text-slate-400 italic">Sin vincular</span>}</td>
                <td className="px-6 py-4"><Badge status={doc.status} /></td>
                <td className="px-6 py-4 text-right"><button className="text-slate-400 hover:text-blue-600 p-1"><MoreVertical size={18} /></button></td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// Vista: Validar Documento
const ValidateDocumentView = () => {
  const [code, setCode] = useState('');
  const [validationResult, setValidationResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const handleValidate = (e) => {
    e.preventDefault(); if (!code) return; setLoading(true); setValidationResult(null);
    setTimeout(() => { setLoading(false); setValidationResult({ valid: true, docId: 'DOC-2026-001', title: 'Resolución Ministerial 45/2026', date: '2026-02-02', author: 'Rodrigo Antola', hash: '8a7b9c1d2e3f4g5h6i7j8k9l0m...', status: 'Vigente' }); }, 1500);
  };
  return (
    <div className="max-w-3xl mx-auto space-y-8 animate-fadeIn">
      <div className="text-center space-y-2"><h2 className="text-2xl font-bold text-slate-800">Validación de Documentos</h2><p className="text-slate-500">Verifique la autenticidad e integridad de los documentos emitidos.</p></div>
      <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
        <form onSubmit={handleValidate} className="space-y-4">
          <label className="block text-sm font-medium text-slate-700">Código de Verificación (CVD) o Hash del Documento</label>
          <div className="flex gap-4">
            <input type="text" value={code} onChange={(e) => setCode(e.target.value)} placeholder="Ej: 8a7b9c... o Escanee el código QR" className="flex-1 border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm" />
            <button type="button" className="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-600" title="Escanear QR"><QrCode size={20} /></button>
            <button type="submit" disabled={loading || !code} className={`px-6 py-3 rounded-lg text-white font-medium flex items-center space-x-2 min-w-[140px] justify-center transition-colors ${loading || !code ? 'bg-slate-400 cursor-not-allowed' : 'bg-blue-900 hover:bg-blue-800'}`}>
              {loading ? <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full" /> : <><ShieldCheck size={20} /><span>Validar</span></>}
            </button>
          </div>
          <p className="text-xs text-slate-400">Puede encontrar el código en el pie de página del documento o escaneando el código QR.</p>
        </form>
        {validationResult && (
          <div className="mt-8 border-t border-slate-100 pt-6 animate-fadeIn">
            <div className={`p-4 rounded-lg flex items-center space-x-3 mb-6 ${validationResult.valid ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800'}`}>
              <CheckCircle size={24} className={validationResult.valid ? 'text-green-600' : 'text-red-600'} />
              <div><p className="font-bold text-lg">{validationResult.valid ? 'Documento Auténtico' : 'Documento Inválido'}</p><p className="text-sm opacity-80">{validationResult.valid ? 'La firma digital y el sello de integridad son válidos.' : 'No se encontró el documento o ha sido alterado.'}</p></div>
            </div>
            {validationResult.valid && (
              <div className="grid grid-cols-2 gap-6 text-sm">
                <div className="space-y-4"><div><span className="block text-xs text-slate-500 uppercase font-semibold">Documento</span><span className="block font-medium text-slate-800 text-base">{validationResult.title}</span></div><div><span className="block text-xs text-slate-500 uppercase font-semibold">Identificador</span><span className="block font-mono text-slate-700 bg-slate-50 p-1 rounded w-fit">{validationResult.docId}</span></div></div>
                <div className="space-y-4"><div><span className="block text-xs text-slate-500 uppercase font-semibold">Firmante</span><span className="block text-slate-800">{validationResult.author}</span></div><div><span className="block text-xs text-slate-500 uppercase font-semibold">Fecha de Emisión</span><span className="block text-slate-800">{validationResult.date}</span></div><div><span className="block text-xs text-slate-500 uppercase font-semibold">Estado</span><Badge status={validationResult.status} /></div></div>
                <div className="col-span-2"><span className="block text-xs text-slate-500 uppercase font-semibold mb-1">Huella Digital (Hash SHA-256)</span><div className="font-mono text-xs text-slate-500 bg-slate-100 p-3 rounded-lg break-all">{validationResult.hash}</div></div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

// Vista: Crear Documento
const CreateDocumentView = ({ setActiveTab, documents, setDocuments }) => {
  const [step, setStep] = useState(1);
  const [creationMode, setCreationMode] = useState('word');
  const [uploading, setUploading] = useState(false);
  const [downloadingTemplate, setDownloadingTemplate] = useState(null);
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [showDigitaliaModal, setShowDigitaliaModal] = useState(false);
  const [digitaliaSearch, setDigitaliaSearch] = useState('');
  const [selectedDigitaliaExp, setSelectedDigitaliaExp] = useState(null);
  const [relatedTramites, setRelatedTramites] = useState([]);
  const [isSaved, setIsSaved] = useState(false); 
  const [formData, setFormData] = useState({ title: '', date: new Date().toISOString().split('T')[0], responsible: 'Cynthia Gonzalez', visibility: 'Público', content: 'Se procede a la firma del presente documento.' });

  useEffect(() => { if (selectedTemplate && creationMode === 'form') { setFormData(prev => ({ ...prev, title: `${selectedTemplate} N° 2026/45` })); } }, [selectedTemplate, creationMode]);

  const handleDownloadTemplate = (e, type) => { e.stopPropagation(); setDownloadingTemplate(type); setTimeout(() => { const element = document.createElement("a"); const fileContent = `Plantilla Oficial para ${type}\n\nGobierno Nacional\n\n[Espacio reservado para contenido]`; const file = new Blob([fileContent], {type: 'text/plain'}); element.href = URL.createObjectURL(file); element.download = `Plantilla_${type.replace(' ', '_')}.docx`; document.body.appendChild(element); element.click(); document.body.removeChild(element); setDownloadingTemplate(null); }, 1000); };
  const handleUpload = () => { setUploading(true); setTimeout(() => { setUploading(false); setStep(3); }, 2000); };
  const handleFormSubmit = () => { setUploading(true); setTimeout(() => { setUploading(false); setStep(3); }, 1500); };
  const handleSaveRepository = () => { setIsSaved(true); const newDoc = { id: `DOC-2026-00${documents.length + 1}`, title: creationMode === 'form' ? formData.title : `${selectedTemplate} N° 2026/45`, type: selectedTemplate || 'Documento Generado', author: formData.responsible, date: formData.date, status: 'Guardado', digitaliaId: null, hash: '8a7b9c...', size: '1.5 MB' }; setDocuments(prev => [newDoc, ...prev]); };
  const handleAddTramite = () => { if (selectedDigitaliaExp && !relatedTramites.find(t => t.id === selectedDigitaliaExp.id)) { setRelatedTramites([...relatedTramites, selectedDigitaliaExp]); setSelectedDigitaliaExp(null); setDigitaliaSearch(''); } };
  const handleRemoveTramite = (idToRemove) => { setRelatedTramites(relatedTramites.filter(t => t.id !== idToRemove)); };
  const handleSaveRelations = () => { setShowDigitaliaModal(false); setDigitaliaSearch(''); setSelectedDigitaliaExp(null); if (relatedTramites.length > 0) { alert(`Se han vinculado ${relatedTramites.length} trámites al documento correctamente.`); } };

  return (
    <div className="max-w-4xl mx-auto space-y-8 relative animate-fadeIn">
      <div className="mb-8"><button onClick={() => setActiveTab('repository')} className="text-sm text-slate-500 hover:text-blue-900 mb-2 flex items-center">← Volver al repositorio</button><h2 className="text-2xl font-bold text-slate-800">Generador de Documentos (GDL)</h2><p className="text-slate-500">Cree documentos oficiales con validación automática y sellado institucional.</p></div>
      <div className="flex items-center justify-between px-10 relative">
        <div className="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-slate-200 -z-10"></div>
        {[1, 2, 3].map((s) => (
          <div key={s} className={`flex flex-col items-center bg-white px-2 ${step >= s ? 'text-blue-900' : 'text-slate-400'}`}>
            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold border-2 transition-colors ${step >= s ? 'bg-blue-900 text-white border-blue-900' : 'bg-white border-slate-300'}`}>{s}</div>
            <span className="text-xs font-medium mt-2 bg-white px-1">{s === 1 ? 'Tipo y Método' : s === 2 ? (creationMode === 'word' ? 'Carga' : 'Redacción') : 'Validación'}</span>
          </div>
        ))}
      </div>
      <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200 min-h-[400px]">
        {step === 1 && (
          <div className="space-y-6 animate-fadeIn">
            <div className="flex justify-between items-center border-b border-slate-100 pb-4"><h3 className="text-lg font-semibold text-slate-800">1. Seleccione método y tipo de documento</h3></div>
            <div className="flex space-x-4 mb-6">
              <button onClick={() => setCreationMode('word')} className={`flex-1 p-4 rounded-xl border-2 flex items-center justify-center space-x-3 transition-all ${creationMode === 'word' ? 'border-blue-600 bg-blue-50 text-blue-900' : 'border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                  <div className="bg-white p-2 rounded-lg shadow-sm"><FileText size={24} /></div><div className="text-left"><p className="font-semibold">Plantilla Word</p><p className="text-xs opacity-75">Descargar, editar offline y subir.</p></div>
              </button>
              <button onClick={() => setCreationMode('form')} className={`flex-1 p-4 rounded-xl border-2 flex items-center justify-center space-x-3 transition-all ${creationMode === 'form' ? 'border-blue-600 bg-blue-50 text-blue-900' : 'border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                  <div className="bg-white p-2 rounded-lg shadow-sm"><Monitor size={24} /></div><div className="text-left"><p className="font-semibold">Formulario Web</p><p className="text-xs opacity-75">Completar datos en línea.</p></div>
              </button>
            </div>
            <p className="text-sm text-slate-600 mb-4">Seleccione el tipo de documento a generar:</p>
            <div className="grid grid-cols-2 gap-4">
              {['Resolución Ministerial', 'Informe Técnico', 'Dictamen Jurídico', 'Memorándum'].map((type) => (
                <div key={type} onClick={() => setSelectedTemplate(type)} className={`border rounded-lg p-4 transition cursor-pointer group relative ${selectedTemplate === type ? 'border-blue-600 bg-blue-50 ring-1 ring-blue-600' : 'border-slate-200 hover:border-blue-400 hover:shadow-md'}`}>
                  <div className="flex justify-between items-start">
                    <div className="flex items-center space-x-3"><div className={`p-2 rounded-lg transition ${selectedTemplate === type ? 'bg-blue-200 text-blue-800' : 'bg-blue-50 text-blue-700'}`}>{creationMode === 'word' ? <FileText size={24} /> : <Edit3 size={24} />}</div><div><span className="font-medium text-slate-700 block">{type}</span><span className="text-xs text-slate-500">{creationMode === 'word' ? 'Formato Word (.docx)' : 'Formulario Digital'}</span></div></div>
                    {creationMode === 'word' && (<button onClick={(e) => handleDownloadTemplate(e, type)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-100 rounded-full transition-colors relative z-10" title="Descargar Plantilla">{downloadingTemplate === type ? <div className="animate-spin h-5 w-5 border-2 border-blue-600 border-t-transparent rounded-full" /> : <Download size={20} />}</button>)}
                  </div>
                </div>
              ))}
            </div>
            <div className="flex justify-end pt-4"><button onClick={() => setStep(2)} disabled={!selectedTemplate} className={`px-6 py-2 rounded-lg flex items-center space-x-2 transition ${!selectedTemplate ? 'bg-slate-300 text-slate-500 cursor-not-allowed' : 'bg-blue-900 text-white hover:bg-blue-800'}`}><span>Continuar</span><ArrowRight size={18} /></button></div>
          </div>
        )}
        {step === 2 && (
          <div className="space-y-6 animate-fadeIn">
            {creationMode === 'word' ? (
              <div className="text-center space-y-6">
                  <h3 className="text-lg font-semibold text-slate-800">2. Suba su documento trabajado</h3>
                  <p className="text-sm text-slate-600">Suba el archivo <strong>{selectedTemplate}</strong> editado. El sistema procesará el archivo Word, agregará encabezados y generará el código QR.</p>
                  <div className="border-2 border-dashed border-slate-300 rounded-xl p-12 hover:bg-slate-50 transition cursor-pointer" onClick={handleUpload}>
                      {uploading ? <div className="space-y-4"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mx-auto"></div><p className="text-blue-900 font-medium">Procesando documento e inyectando metadatos...</p></div> : <div className="space-y-4"><div className="mx-auto bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center text-blue-600"><Upload size={32} /></div><div><p className="text-slate-700 font-medium">Haga clic para subir su archivo .DOCX</p><p className="text-xs text-slate-400 mt-1">Máximo 25MB</p></div></div>}
                  </div>
              </div>
            ) : (
              <div className="space-y-6">
                  <div className="flex justify-between items-center"><h3 className="text-lg font-semibold text-slate-800">2. Complete los datos del documento</h3><span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded">Modo: Formulario Web</span></div>
                  <div className="space-y-4">
                      <div className="grid grid-cols-3 gap-4">
                          <div className="col-span-2"><label className="block text-sm font-medium text-slate-700 mb-1">Título del Documento</label><input type="text" value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" /></div>
                          <div><label className="block text-sm font-medium text-slate-700 mb-1">Fecha del Documento</label><input type="date" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" /></div>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                          <div><label className="block text-sm font-medium text-slate-700 mb-1">Responsable</label><div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><User size={16} className="text-slate-400" /></div><input type="text" value={formData.responsible} onChange={(e) => setFormData({...formData, responsible: e.target.value})} className="w-full pl-10 border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" /></div></div>
                          <div><label className="block text-sm font-medium text-slate-700 mb-1">Tipo de Visibilidad</label><select value={formData.visibility} onChange={(e) => setFormData({...formData, visibility: e.target.value})} className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"><option value="Público">Público</option><option value="Privado">Privado</option></select></div>
                      </div>
                      <div><label className="block text-sm font-medium text-slate-700 mb-1">Cuerpo del Documento</label><textarea value={formData.content} onChange={(e) => setFormData({...formData, content: e.target.value})} rows={8} className="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none font-sans" /><p className="text-xs text-slate-400 mt-1 text-right">Se agregará automáticamente el membrete y pie de página.</p></div>
                  </div>
                  <div className="flex justify-end pt-4"><button onClick={handleFormSubmit} className="bg-blue-900 text-white px-6 py-2 rounded-lg hover:bg-blue-800 flex items-center space-x-2">{uploading ? <><div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full" /><span>Generando...</span></> : <><span>Generar Vista Previa</span><ArrowRight size={18} /></>}</button></div>
              </div>
            )}
            <div className="flex justify-start"><button onClick={() => setStep(1)} className="text-sm text-slate-500 hover:text-blue-900 mt-4">← Volver a selección de plantilla</button></div>
          </div>
        )}
        {step === 3 && (
          <div className="space-y-6 animate-fadeIn">
              <div className="flex items-center space-x-2 text-green-600 bg-green-50 p-3 rounded-lg border border-green-200"><CheckCircle size={20} /><span className="font-medium">Documento procesado exitosamente</span></div>
            <div className="flex space-x-6">
              <div className="flex-1 bg-slate-100 p-4 rounded-lg border border-slate-300 h-96 overflow-y-auto relative">
                <div className="bg-white shadow-sm p-8 min-h-full mx-auto w-full max-w-lg text-[10px] space-y-4 relative">
                  <div className="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-blue-900 to-blue-800 flex items-center justify-between px-6 text-white"><span className="font-serif font-bold">GOBIERNO NACIONAL</span><div className="bg-white/20 p-1 rounded"><QrCode size={24} /></div></div>
                  <div className="mt-16 text-center space-y-2"><h1 className="font-bold text-lg text-slate-900 uppercase">{creationMode === 'form' ? formData.title : `${selectedTemplate} N° 2026/45`}</h1><p className="text-slate-500">Generado automáticamente por GDL</p></div>
                  <div className="space-y-2 text-slate-600 text-justify"><p className="whitespace-pre-wrap">{creationMode === 'form' ? formData.content : 'Se procede a la firma del presente documento.'}</p><div className="p-4 bg-slate-50 border border-slate-200 rounded mt-4"><p className="font-bold">Datos de Validación:</p><p>Hash: 8a7b9c... (Integridad Verificada)</p><p>Fecha: {creationMode === 'form' ? formData.date : '02/02/2026'}</p>{creationMode === 'form' && (<><p>Responsable: {formData.responsible}</p><p>Visibilidad: {formData.visibility}</p></>)}<p>Validador: https://gdl.gov.py/v/8a7b9c</p></div></div>
                </div>
              </div>
              <div className="w-1/3 space-y-4">
                <h4 className="font-semibold text-slate-800">Acciones Siguientes</h4>
                <button onClick={handleSaveRepository} disabled={isSaved} className={`w-full px-4 py-3 rounded-lg flex items-center justify-center space-x-2 transition-all ${isSaved ? 'bg-green-50 text-green-700 border border-green-200 cursor-default' : 'bg-blue-900 text-white hover:bg-blue-800 shadow-md'}`}>{isSaved ? <CheckCircle size={18} /> : <FileCheck size={18} />}<span>{isSaved ? 'Guardado en Repositorio' : 'Guardar en Repositorio'}</span></button>
                <div className="relative"><button onClick={() => setShowDigitaliaModal(true)} disabled={!isSaved} className={`w-full border px-4 py-3 rounded-lg flex items-center justify-center space-x-2 transition-all ${!isSaved ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed' : 'bg-indigo-600 border-indigo-600 text-white hover:bg-indigo-700 shadow-md animate-pulse-once'}`}><LinkIcon size={18} /><span>Relacionar a Digitalia</span></button>{!isSaved && (<p className="text-[10px] text-slate-400 text-center mt-2 px-2">* Debe guardar el documento antes de poder relacionarlo a un expediente.</p>)}</div>
                <div className="pt-4 border-t border-slate-200"><p className="text-xs text-slate-500 mb-2">Este documento ahora posee validez jurídica digital y no puede ser alterado sin romper el sello de integridad.</p></div>
              </div>
            </div>
          </div>
        )}
        {showDigitaliaModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fadeIn flex flex-col max-h-[90vh]">
                  <div className="p-6 border-b border-slate-100 flex justify-between items-center"><h3 className="font-bold text-lg text-slate-800">Relacionar a Trámite Digitalia</h3><button onClick={() => setShowDigitaliaModal(false)} className="text-slate-400 hover:text-slate-600"><X size={24} /></button></div>
                  <div className="p-6 space-y-4 overflow-y-auto flex-1">
                      <div className="bg-indigo-50 border border-indigo-100 p-4 rounded-lg flex items-start space-x-3 mb-4"><LinkIcon className="text-indigo-600 mt-1" size={20} /><div><p className="text-sm text-indigo-800 font-medium">Vinculación por Referencia</p><p className="text-xs text-indigo-600">El documento permanecerá en el Repositorio Central. Solo se enviará un puntero seguro al trámite seleccionado.</p></div></div>
                      <div><label className="block text-sm font-medium text-slate-700 mb-1">Buscar Expediente / Trámite</label><div className="flex gap-2"><div className="flex flex-1"><span className="inline-flex items-center px-3 rounded-l-md border border-r-0 border-slate-300 bg-slate-50 text-slate-500 text-sm">EXP-</span><input type="text" value={digitaliaSearch} onChange={(e) => setDigitaliaSearch(e.target.value)} className="flex-1 block w-full rounded-none rounded-r-md border border-slate-300 py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="2026-XXXX" /></div><button onClick={handleAddTramite} disabled={!selectedDigitaliaExp} className={`px-4 py-2 rounded-md text-sm font-medium text-white flex items-center space-x-2 transition-colors ${!selectedDigitaliaExp ? 'bg-slate-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}><Plus size={16} /><span>Agregar</span></button></div></div>
                      {digitaliaSearch.length > 3 && !selectedDigitaliaExp && (
                          <div className="space-y-2 mt-2 animate-fadeIn"><p className="text-xs text-slate-500 font-medium uppercase">Resultados encontrados</p><div className="border border-slate-200 rounded-lg divide-y divide-slate-100 max-h-32 overflow-y-auto">
                                  <button onClick={() => setSelectedDigitaliaExp({ id: 'EXP-2026-8812', title: 'Solicitud de Insumos - Dpto. IT' })} className="w-full text-left p-3 hover:bg-blue-50 flex justify-between items-center group transition-colors"><div><p className="font-medium text-slate-800">EXP-2026-8812</p><p className="text-xs text-slate-500">Solicitud de Insumos - Dpto. IT</p></div></button>
                                  <button onClick={() => setSelectedDigitaliaExp({ id: 'EXP-2026-9923', title: 'Auditoría Financiera Q1' })} className="w-full text-left p-3 hover:bg-blue-50 flex justify-between items-center group transition-colors"><div><p className="font-medium text-slate-800">EXP-2026-9923</p><p className="text-xs text-slate-500">Auditoría Financiera Q1</p></div></button>
                              </div></div>
                      )}
                      {selectedDigitaliaExp && (<div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex justify-between items-center mt-2"><div><p className="font-bold text-blue-900">{selectedDigitaliaExp.id}</p><p className="text-xs text-blue-700">{selectedDigitaliaExp.title}</p></div><span className="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded">Seleccionado</span></div>)}
                      <div className="mt-6"><h4 className="text-sm font-semibold text-slate-800 mb-2">Trámites a Vincular ({relatedTramites.length})</h4><div className="border border-slate-200 rounded-lg bg-slate-50 min-h-[100px] max-h-[200px] overflow-y-auto p-2 space-y-2">{relatedTramites.length === 0 ? (<div className="h-full flex flex-col items-center justify-center text-slate-400 py-6"><LinkIcon size={24} className="mb-2 opacity-50" /><p className="text-xs">No hay trámites en la lista.</p><p className="text-[10px]">Busque y agregue trámites arriba.</p></div>) : (relatedTramites.map((tramite) => (<div key={tramite.id} className="bg-white border border-slate-200 p-3 rounded-md flex justify-between items-center shadow-sm"><div className="flex items-center space-x-3"><div className="bg-indigo-100 p-2 rounded text-indigo-600"><FileText size={16} /></div><div><p className="font-medium text-sm text-slate-800">{tramite.id}</p><p className="text-xs text-slate-500">{tramite.title}</p></div></div><button onClick={() => handleRemoveTramite(tramite.id)} className="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-full transition-colors" title="Eliminar de la lista"><Trash2 size={16} /></button></div>)))}</div></div>
                  </div>
                  <div className="bg-slate-50 p-4 flex justify-end items-center space-x-3 border-t border-slate-100"><button onClick={() => setShowDigitaliaModal(false)} className="text-slate-600 font-medium text-sm px-4 py-2 hover:bg-slate-200 rounded-lg">Cancelar</button><button onClick={handleSaveRelations} disabled={relatedTramites.length === 0} className={`px-4 py-2 rounded-lg text-sm font-medium text-white flex items-center space-x-2 ${relatedTramites.length === 0 ? 'bg-slate-300 cursor-not-allowed' : 'bg-blue-900 hover:bg-blue-800 shadow-sm'}`}><LinkIcon size={16} /><span>Guardar Relación</span></button></div>
              </div>
          </div>
        )}
      </div>
    </div>
  );
};

// Vista: Integración Digitalia
const IntegrationView = ({ documents }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [selectedExpediente, setSelectedExpediente] = useState(null);
  const [selectedDocs, setSelectedDocs] = useState([]); 
  const [docSearchTerm, setDocSearchTerm] = useState('');
  const [showSummary, setShowSummary] = useState(false);

  const handleSearch = () => { if (searchTerm.length > 3) { setSearchResults([ { id: 'EXP-2026-8812', title: 'Solicitud de Insumos - Dpto. IT', area: 'Tecnología' }, { id: 'EXP-2026-9923', title: 'Auditoría Financiera Q1', area: 'Finanzas' }, { id: 'EXP-2026-1024', title: 'Reestructuración de Personal', area: 'Recursos Humanos' } ]); } else { setSearchResults([]); } };
  const handleSelectExpediente = (exp) => { setSelectedExpediente(exp); setSearchResults([]); setSearchTerm(''); };
  const handleClearExpediente = () => { setSelectedExpediente(null); setSelectedDocs([]); setDocSearchTerm(''); };
  const toggleDocSelection = (docId) => { if (selectedDocs.includes(docId)) { setSelectedDocs(selectedDocs.filter(id => id !== docId)); } else { setSelectedDocs([...selectedDocs, docId]); } };
  const handleConfirmLink = () => { if (selectedDocs.length > 0 && selectedExpediente) { setShowSummary(true); } };
  const handleFinish = () => { setShowSummary(false); handleClearExpediente(); };
  const filteredDocs = documents.filter(doc => doc.title.toLowerCase().includes(docSearchTerm.toLowerCase()) || doc.id.toLowerCase().includes(docSearchTerm.toLowerCase()));

  if (showSummary) {
      return (
          <div className="space-y-6 animate-fadeIn">
              <div className="bg-green-50 border border-green-200 p-6 rounded-xl flex items-center space-x-4"><div className="bg-green-100 p-3 rounded-full text-green-700"><CheckCircle size={32} /></div><div><h3 className="text-xl font-bold text-green-900">¡Vinculación Exitosa!</h3><p className="text-green-700">Se han asociado correctamente los documentos seleccionados al expediente.</p></div></div>
              <div className="bg-white border border-slate-200 rounded-xl shadow-sm p-6">
                  <h4 className="font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">Resumen de Operación</h4>
                  <div className="grid grid-cols-2 gap-8 mb-6"><div><p className="text-xs text-slate-500 uppercase font-semibold mb-1">Expediente Destino</p><div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100"><p className="font-bold text-indigo-900">{selectedExpediente.id}</p><p className="text-sm text-indigo-800">{selectedExpediente.title}</p></div></div><div><p className="text-xs text-slate-500 uppercase font-semibold mb-1">Total Documentos</p><p className="text-2xl font-bold text-slate-800">{selectedDocs.length}</p></div></div>
                  <div><p className="text-xs text-slate-500 uppercase font-semibold mb-2">Documentos Vinculados</p><div className="border border-slate-200 rounded-lg overflow-hidden">{selectedDocs.map(docId => { const doc = documents.find(d => d.id === docId); return ( <div key={docId} className="flex items-center space-x-3 p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50"><FileText size={16} className="text-slate-400" /><span className="text-sm font-medium text-slate-700">{doc?.title}</span><span className="text-xs text-slate-400">({docId})</span></div> ); })}</div></div>
              </div>
              <div className="flex justify-end space-x-4"><button onClick={handleFinish} className="bg-blue-900 text-white px-6 py-3 rounded-lg hover:bg-blue-800 flex items-center space-x-2"><span>Nueva Vinculación</span><ArrowRight size={18} /></button></div>
          </div>
      );
  }

  return (
    <div className="space-y-6 animate-fadeIn">
        <div className="mb-6"><h2 className="text-2xl font-bold text-slate-800">Integración con Digitalia</h2><p className="text-slate-500">Vincular documentos múltiples del repositorio a un expediente existente.</p></div>
        <div className="grid grid-cols-3 gap-6">
            <div className="col-span-2 space-y-6">
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 min-h-[500px] flex flex-col">
                    <h3 className="font-semibold text-slate-800 mb-4 flex items-center space-x-2"><LinkIcon className="text-indigo-600" size={20} /><span>Vinculación Masiva</span></h3>
                    {!selectedExpediente ? (
                        <div className="space-y-4 animate-fadeIn">
                            <label className="block text-sm font-medium text-slate-700">1. Buscar Expediente Destino</label><div className="flex gap-2"><div className="flex flex-1"><span className="inline-flex items-center px-3 rounded-l-md border border-r-0 border-slate-300 bg-slate-50 text-slate-500 text-sm">EXP-</span><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSearch()} className="flex-1 block w-full rounded-none rounded-r-md border border-slate-300 py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="2026-XXXX" /></div><button onClick={handleSearch} className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 flex items-center space-x-2"><Search size={16} /><span>Buscar</span></button></div>
                            {searchResults.length > 0 && (<div className="mt-4 border border-slate-200 rounded-lg overflow-hidden"><div className="bg-slate-50 px-4 py-2 border-b border-slate-200 text-xs font-semibold text-slate-500 uppercase">Resultados Encontrados</div><div className="divide-y divide-slate-100">{searchResults.map((exp) => (<button key={exp.id} onClick={() => handleSelectExpediente(exp)} className="w-full text-left px-4 py-3 hover:bg-indigo-50 transition-colors flex justify-between items-center group"><div><p className="font-medium text-indigo-900">{exp.id}</p><p className="text-sm text-slate-600">{exp.title}</p></div><div className="flex items-center space-x-2"><span className="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">{exp.area}</span><ArrowRight size={16} className="text-slate-300 group-hover:text-indigo-500" /></div></button>))}</div></div>)}
                            {searchTerm.length > 0 && searchResults.length === 0 && (<p className="text-sm text-slate-400 italic text-center py-4">Ingrese al menos 4 dígitos y presione Buscar.</p>)}
                        </div>
                    ) : (
                        <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4 flex justify-between items-center animate-fadeIn"><div className="flex items-center space-x-3"><div className="bg-indigo-100 p-2 rounded-full text-indigo-700"><FolderOpen size={24} /></div><div><p className="text-xs text-indigo-600 font-semibold uppercase tracking-wider">Expediente Destino</p><p className="font-bold text-lg text-indigo-900">{selectedExpediente.id}</p><p className="text-sm text-indigo-800">{selectedExpediente.title}</p></div></div><button onClick={handleClearExpediente} className="text-slate-400 hover:text-red-500 p-2 hover:bg-white rounded-full transition-colors" title="Cambiar Expediente"><X size={20} /></button></div>
                    )}
                    {selectedExpediente && (
                        <div className="flex-1 flex flex-col animate-fadeIn border-t border-slate-200 pt-6">
                            <div className="flex justify-between items-center mb-3"><label className="block text-sm font-medium text-slate-700">2. Seleccione Documentos a Vincular</label><span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">{selectedDocs.length} seleccionados</span></div>
                            <div className="mb-3 relative"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} /><input type="text" placeholder="Filtrar documentos por nombre o ID..." className="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500 focus:outline-none" value={docSearchTerm} onChange={(e) => setDocSearchTerm(e.target.value)} /></div>
                            <div className="border border-slate-200 rounded-lg flex-1 overflow-y-auto max-h-64"><div className="divide-y divide-slate-100">{filteredDocs.length > 0 ? (filteredDocs.map((doc) => { const isSelected = selectedDocs.includes(doc.id); return ( <div key={doc.id} onClick={() => toggleDocSelection(doc.id)} className={`px-4 py-3 flex items-center space-x-4 cursor-pointer transition-colors ${isSelected ? 'bg-blue-50' : 'hover:bg-slate-50'}`}><div className={`text-slate-400 ${isSelected ? 'text-blue-600' : ''}`}>{isSelected ? <CheckSquare size={20} /> : <Square size={20} />}</div><div className="flex-1"><p className={`font-medium text-sm ${isSelected ? 'text-blue-900' : 'text-slate-700'}`}>{doc.title}</p><div className="flex items-center space-x-2 text-xs text-slate-500 mt-0.5"><span>{doc.id}</span><span>•</span><span>{doc.date}</span></div></div>{isSelected && (<span className="text-xs font-bold text-blue-600 bg-white px-2 py-1 rounded border border-blue-200">Vincular</span>)}</div> ); })) : (<div className="p-4 text-center text-sm text-slate-400">No se encontraron documentos que coincidan con la búsqueda.</div>)}</div></div>
                            <div className="mt-6 flex justify-end items-center space-x-4 pt-4 border-t border-slate-100"><button onClick={handleClearExpediente} className="text-slate-600 hover:text-slate-800 text-sm font-medium">Cancelar</button><button onClick={handleConfirmLink} disabled={selectedDocs.length === 0} className={`px-6 py-2 rounded-lg text-white font-medium flex items-center space-x-2 transition-colors ${selectedDocs.length === 0 ? 'bg-slate-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 shadow-md'}`}><LinkIcon size={18} /><span>Confirmar Vinculación ({selectedDocs.length})</span></button></div>
                        </div>
                    )}
                </div>
            </div>
            <div className="col-span-1 space-y-6">
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6"><h3 className="font-semibold text-slate-800 mb-4 flex items-center space-x-2"><ShieldCheck className="text-green-600" size={20} /><span>Estado del Servicio</span></h3><div className="space-y-4"><div className="flex justify-between items-center text-sm"><span className="text-slate-600">API Digitalia:</span><span className="text-green-600 font-medium flex items-center"><div className="w-2 h-2 bg-green-500 rounded-full mr-2"></div>Conectado</span></div><div className="flex justify-between items-center text-sm"><span className="text-slate-600">Servicio de Sellado:</span><span className="text-green-600 font-medium flex items-center"><div className="w-2 h-2 bg-green-500 rounded-full mr-2"></div>Operativo</span></div></div></div>
                <div className="bg-blue-50 border border-blue-100 rounded-xl p-6"><h4 className="text-blue-900 font-semibold mb-2 text-sm">Información</h4><p className="text-xs text-blue-800 leading-relaxed">Esta herramienta permite la <strong>vinculación inversa</strong>.<br/><br/>En lugar de ir documento por documento, seleccione un expediente destino y asigne múltiples archivos del repositorio en una sola acción.</p></div>
            </div>
        </div>
    </div>
  );
};

// ==================================================================================
// CONTENEDOR PRINCIPAL
// ==================================================================================

const GestionDocumentalModule = ({ onBack }) => {
  const [activeTab, setActiveTab] = useState('repository');
  const [documents, setDocuments] = useState([
    { id: 'DOC-2026-001', title: 'Resolución Ministerial 45/2026', type: 'Resolución', author: 'Rodrigo Antola', date: '2026-02-02', status: 'Firmado', digitaliaId: 'EXP-9923', hash: 'a1b2c3d4...', size: '2.4 MB' },
    { id: 'DOC-2026-002', title: 'Informe Técnico Auditoría Interna', type: 'Informe Técnico', author: 'Cynthia Gonzalez', date: '2026-02-01', status: 'Borrador', digitaliaId: null, hash: null, size: '4.1 MB' },
    { id: 'DOC-2026-003', title: 'Dictamen Financiero Proyecto GDL', type: 'Dictamen', author: 'Fernando Mancia', date: '2026-01-28', status: 'Firmado', digitaliaId: 'EXP-8812', hash: 'f9e8d7c6...', size: '1.2 MB' },
    { id: 'DOC-2026-004', title: 'Anexo I - Presupuesto General', type: 'Anexo', author: 'Fernando Mancia', date: '2026-01-29', status: 'Firmado', digitaliaId: null, hash: 'c8d9e0...', size: '0.8 MB' },
    { id: 'DOC-2026-005', title: 'Nota de Remisión N° 120', type: 'Nota', author: 'Cynthia Gonzalez', date: '2026-02-01', status: 'Firmado', digitaliaId: null, hash: 'f1a2b3...', size: '0.3 MB' }
  ]);

  return (
    <div className="flex h-screen bg-slate-100 font-sans text-slate-900 animate-in fade-in duration-300">
      <div className="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20">
        <div className="p-6 border-b border-slate-800">
          <div className="flex items-center space-x-3">
            <div className="bg-white/10 p-2 rounded-lg"><Building size={24} className="text-blue-400" /></div>
            <div><h1 className="font-bold text-lg leading-tight">Gestión Documental</h1><p className="text-xs text-slate-400">Gobierno Nacional</p></div>
          </div>
        </div>
        
        <nav className="flex-1 py-6 space-y-1">
          <GDLSidebarItem id="repository" icon={FolderOpen} label="Repositorio" active={activeTab === 'repository'} onClick={setActiveTab} />
          <GDLSidebarItem id="create" icon={Plus} label="Nuevo Documento" active={activeTab === 'create'} onClick={setActiveTab} />
          <GDLSidebarItem id="validate" icon={Shield} label="Validar Documento" active={activeTab === 'validate'} onClick={setActiveTab} />
          <GDLSidebarItem id="integration" icon={LinkIcon} label="Digitalia" active={activeTab === 'integration'} onClick={setActiveTab} />
        </nav>

        {/* Botón Volver añadido */}
        <div className="px-4 pb-2">
            <button onClick={onBack} className="w-full flex items-center space-x-3 px-4 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white rounded transition-colors">
                <Grid size={20} /> <span>Menú Principal</span>
            </button>
        </div>

        <div className="p-4 bg-slate-800 m-4 rounded-xl">
            <div className="flex items-center space-x-3 mb-2">
                <div className="bg-blue-500 rounded-full p-1"><User size={14} className="text-white" /></div>
                <div><p className="text-sm font-medium">Cynthia Gonzalez</p><p className="text-xs text-slate-400">Analista</p></div>
            </div>
        </div>
      </div>

      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="bg-white shadow-sm border-b border-slate-200 px-8 py-4 flex justify-between items-center z-10">
            <div><h2 className="text-xl font-semibold text-slate-800">{activeTab === 'repository' && 'Bandeja de Documentos'}{activeTab === 'create' && 'Generación de Documentos'}{activeTab === 'validate' && 'Validación Pública'}{activeTab === 'integration' && 'Interoperabilidad'}</h2></div>
            <div className="flex items-center space-x-4"><div className="text-right hidden md:block"><p className="text-xs text-slate-500">Última sincronización</p><p className="text-sm font-medium text-slate-700">Hoy, 10:00 AM</p></div></div>
        </header>

        <main className="flex-1 overflow-auto p-8">
          {activeTab === 'repository' && <RepositoryView setActiveTab={setActiveTab} documents={documents} />}
          {activeTab === 'create' && <CreateDocumentView setActiveTab={setActiveTab} documents={documents} setDocuments={setDocuments} />}
          {activeTab === 'validate' && <ValidateDocumentView />}
          {activeTab === 'integration' && <IntegrationView documents={documents} />}
        </main>
      </div>
    </div>
  );
};

// ==================================================================================
// DASHBOARD PRINCIPAL (HOME)
// ==================================================================================

const MainDashboard = ({ onNavigate }) => {
    return (
        <div className="min-h-screen bg-slate-50 font-sans flex flex-col">
            {/* Header del Dashboard */}
            <header className="bg-white border-b border-slate-200 h-16 px-8 flex items-center justify-between">
                <div className="flex items-center space-x-3">
                    <div className="bg-blue-900 p-2 rounded-lg text-white">
                        <Building size={20} />
                    </div>
                    <div>
                        <h1 className="text-lg font-bold text-slate-800 leading-none">Digitalia</h1>
                        <span className="text-xs text-slate-500 font-medium tracking-wide uppercase">Gobierno Nacional</span>
                    </div>
                </div>
                <div className="flex items-center space-x-6">
                    <div className="hidden md:flex flex-col text-right">
                        <span className="text-sm font-bold text-slate-800">Cynthia Gonzalez</span>
                        <span className="text-xs text-slate-500">Analista Senior • MITIC</span>
                    </div>
                    <div className="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-700 font-bold border border-blue-200">
                        CG
                    </div>
                    <button className="text-slate-400 hover:text-red-500 transition-colors">
                        <LogOut size={20} />
                    </button>
                </div>
            </header>

            {/* Contenido Principal */}
            <main className="flex-1 max-w-6xl mx-auto w-full p-8 flex flex-col justify-center animate-in fade-in duration-500">
                <div className="text-center mb-12 space-y-2">
                    <h2 className="text-3xl font-bold text-slate-800">Bienvenido a Digitalia</h2>
                    <p className="text-slate-500">Seleccione el módulo al que desea acceder para continuar.</p>
                </div>

                <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto w-full">
                    {/* Tarjeta Expedientes */}
                    <div 
                        onClick={() => onNavigate('expedientes')}
                        className="group bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden relative flex flex-col"
                    >
                        <div className="h-2 bg-[#1565c0]"></div>
                        <div className="p-8 flex-1 flex flex-col items-center text-center space-y-4 relative z-10">
                            <div className="w-20 h-20 bg-blue-50 rounded-2xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300">
                                <Files size={40} className="text-[#1565c0]" />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800">Expedientes Electrónicos</h3>
                            <p className="text-slate-500 text-sm leading-relaxed">
                                Gestión de expedientes, bandejas de entrada, pases a firma y seguimiento de trámites administrativos.
                            </p>
                        </div>
                        <div className="bg-slate-50 px-8 py-4 border-t border-slate-100 flex justify-between items-center group-hover:bg-[#1565c0] group-hover:text-white transition-colors duration-300">
                            <span className="text-sm font-semibold">Acceder al módulo</span>
                            <ArrowRight size={18} />
                        </div>
                    </div>

                    {/* Tarjeta Gestión Documental */}
                    <div 
                        onClick={() => onNavigate('gdl')}
                        className="group bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden relative flex flex-col"
                    >
                        <div className="h-2 bg-[#303f9f]"></div>
                        <div className="p-8 flex-1 flex flex-col items-center text-center space-y-4 relative z-10">
                            <div className="w-20 h-20 bg-indigo-50 rounded-2xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300">
                                <Database size={40} className="text-[#303f9f]" />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800">Gestión Documental (GDL)</h3>
                            <p className="text-slate-500 text-sm leading-relaxed">
                                Repositorio central, generación de documentos oficiales, validación QR e interoperabilidad con Digitalia.
                            </p>
                        </div>
                        <div className="bg-slate-50 px-8 py-4 border-t border-slate-100 flex justify-between items-center group-hover:bg-[#303f9f] group-hover:text-white transition-colors duration-300">
                            <span className="text-sm font-semibold">Acceder al módulo</span>
                            <ArrowRight size={18} />
                        </div>
                    </div>
                </div>

                <footer className="mt-16 text-center text-xs text-slate-400">
                    <p>© 2026 Ministerio de Tecnologías de la Información y Comunicación (MITIC).</p>
                    <p className="mt-1">Sistema de Gestión Integrada v3.0.1</p>
                </footer>
            </main>
        </div>
    );
};

// ==================================================================================
// APP ENTRY POINT
// ==================================================================================

const App = () => {
    const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'expedientes', 'gdl'

    const handleNavigate = (view) => {
        setCurrentView(view);
    };

    const handleBack = () => {
        setCurrentView('dashboard');
    };

    return (
        <>
            {currentView === 'dashboard' && <MainDashboard onNavigate={handleNavigate} />}
            {currentView === 'expedientes' && <ExpedientesModule onBack={handleBack} />}
            {currentView === 'gdl' && <GestionDocumentalModule onBack={handleBack} />}
        </>
    );
};

export default App;
